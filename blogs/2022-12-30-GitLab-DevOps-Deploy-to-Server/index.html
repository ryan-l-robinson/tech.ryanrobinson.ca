<p>This continues with <a href="/eleventy-base-blog/tags/gitlab-devops/">the long-stalled GitLab DevOps series</a>. An essential piece of any CI/CD system is deploying to another server. You do not want to have to sign in to each server separately and carry out 15 deployment steps to take backups, pull the updated code, import new configuration, update database schemas, clear caches, etc. You want to hit a button and it rolls out everywhere. You also want to have the ability to easily roll back if you realize a mistake was made.</p>
<p>You will first need <a href="/eleventy-base-blog/websites/gitlab-devops-gitlab-runner/">a GitLab runner</a> on the server you want to deploy to.</p>
<p>As with the earlier post on <a href="/eleventy-base-blog/websites/drupal/gitlab-devops-php-lint/">PHP linting within GitLab CI/CD</a>, in a real scenario this would be split into two projects. In my real usage, I have one project with the general CI/CD functionality, then the specific website project can extend from those functions to push out to the server. In this demo scenario, it is all in <a href="https://github.com/ryan-l-robinson/GitLab-CI-CD">one project of my GitHub</a>.</p>
<h2 id="deploy-yml" tabindex="-1">Deploy.yml <a class="header-anchor" href="#deploy-yml">#</a></h2>
<p>The deploy file provides you a baseline template for deploying code changes, which is in the general CI/CD functionality project. Here's what that might look like:</p>
<pre class="language-yml" tabindex="0"><code class="language-yml"><span class="token comment">## Deploy Jobs ##</span>
<span class="token key atrule">variables</span><span class="token punctuation">:</span>
  <span class="token key atrule">ENVIRONMENT_NAME</span><span class="token punctuation">:</span> <span class="token string">"dev"</span>
  <span class="token key atrule">SERVER_URL</span><span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token key atrule">WEB_ROOT</span><span class="token punctuation">:</span> <span class="token string">"/opt/www/html"</span>

<span class="token comment">### Generic deploy to specified server ###</span>
<span class="token key atrule">.deploy_template</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> $ENVIRONMENT_NAME
    <span class="token key atrule">url</span><span class="token punctuation">:</span> $SERVER_URL
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> echo "Deploying to server at $SERVER_URL"
    <span class="token punctuation">-</span> cd $WEB_ROOT
    <span class="token punctuation">-</span> git fetch
    <span class="token punctuation">-</span> git reset <span class="token punctuation">-</span><span class="token punctuation">-</span>hard
    <span class="token punctuation">-</span> git stash
    <span class="token punctuation">-</span> git pull</code></pre>
<h2 id="project-gitlab-ci-yml" tabindex="-1">Project .gitlab-ci.yml <a class="header-anchor" href="#project-gitlab-ci-yml">#</a></h2>
<p>The other key component is the project's file to extend this deploy job.</p>
<p>Start the project's .gitlab-ci.yml file with including the deploy file from the other project. In a scenario where that is a different project but accessible to the same GitLab user, it would look like this, assuming the project is called gitlab-ci:</p>
<pre class="language-yml" tabindex="0"><code class="language-yml"><span class="token comment"># Includes general CI jobs</span>
<span class="token key atrule">include</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">project</span><span class="token punctuation">:</span> <span class="token string">"[group path to project]/gitlab-ci"</span>
    <span class="token key atrule">ref</span><span class="token punctuation">:</span> main
    <span class="token key atrule">file</span><span class="token punctuation">:</span> deploy.yml</code></pre>
<p>This will now give you the freedom to extend jobs found in the deploy.yml file of the main branch on the gitlab-ci project.</p>
<p>Add deploy as a stage for your project:</p>
<pre class="language-yml" tabindex="0"><code class="language-yml"><span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> test
  <span class="token punctuation">-</span> deploy</code></pre>
<p>Finally, define the job(s) that use(s) the general deploy functionality, passing in the needed variables:</p>
<pre class="language-yml" tabindex="0"><code class="language-yml"><span class="token comment">## Deploy Jobs ##</span>

<span class="token comment">### Deploys to dev server only when changes are made to the dev branch ###</span>
<span class="token key atrule">deploy_dev</span><span class="token punctuation">:</span>
  <span class="token key atrule">extends</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> .deploy_template
  <span class="token key atrule">variables</span><span class="token punctuation">:</span>
    <span class="token key atrule">ENVIRONMENT_NAME</span><span class="token punctuation">:</span> Development
    <span class="token key atrule">SERVER_URL</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>dev url<span class="token punctuation">]</span>
    <span class="token key atrule">WEB_ROOT</span><span class="token punctuation">:</span> /opt/www/html
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">[</span>dev GitLab runner tag<span class="token punctuation">]</span>
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> dev

<span class="token comment">### Deploys to staging server only when changes are made to the main branch ###</span>
<span class="token key atrule">deploy_staging</span><span class="token punctuation">:</span>
  <span class="token key atrule">extends</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> .deploy_template
  <span class="token key atrule">variables</span><span class="token punctuation">:</span>
    <span class="token key atrule">ENVIRONMENT_NAME</span><span class="token punctuation">:</span> Development
    <span class="token key atrule">SERVER_URL</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>dev url<span class="token punctuation">]</span>
    <span class="token key atrule">WEB_ROOT</span><span class="token punctuation">:</span> /opt/www/html
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">[</span>staging GitLab runner tag<span class="token punctuation">]</span>
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> main

<span class="token comment">### Deploys to production only when main branch and manually triggered ###</span>
<span class="token key atrule">deploy_prod1</span><span class="token punctuation">:</span>
  <span class="token key atrule">extends</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> .deploy_template
  <span class="token key atrule">variables</span><span class="token punctuation">:</span>
    <span class="token key atrule">ENVIRONMENT_NAME</span><span class="token punctuation">:</span> Production 1
    <span class="token key atrule">SERVER_URL</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>production 1 URL<span class="token punctuation">]</span>
    <span class="token key atrule">WEB_ROOT</span><span class="token punctuation">:</span> /opt/www/html
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">[</span>prod 1 GitLab runner tag<span class="token punctuation">]</span>
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> main
  <span class="token key atrule">when</span><span class="token punctuation">:</span> manual

<span class="token key atrule">deploy_prod2</span><span class="token punctuation">:</span>
  <span class="token key atrule">extends</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> .deploy_template
  <span class="token key atrule">variables</span><span class="token punctuation">:</span>
    <span class="token key atrule">ENVIRONMENT_NAME</span><span class="token punctuation">:</span> Production 2
    <span class="token key atrule">SERVER_URL</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>production 2 URL<span class="token punctuation">]</span>
    <span class="token key atrule">WEB_ROOT</span><span class="token punctuation">:</span> /opt/www/html
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">[</span>prod 2 GitLab runner tag<span class="token punctuation">]</span>
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> main
  <span class="token key atrule">when</span><span class="token punctuation">:</span> manual</code></pre>
<p>You will need one of these types of jobs for each server to deploy to, with each's corresponding variables. This demo includes a dev server, a staging server, and two production servers.</p>
<h2 id="project-access-token" tabindex="-1">Project access token <a class="header-anchor" href="#project-access-token">#</a></h2>
<p>For this to work smoothly, you can use a project access token. This is a unique token that can be set up on a project – essentially a service account – rather than the connection being tied to a particular user. This is helpful to avoid problem scenarios like a sudden change of staff when the deploy was set up using the former staff's account that no longer exists.</p>
<p>Create a project token by going to the project -&gt; Settings -&gt; Project Access Tokens. Name the token something descriptive for the server that will be using it, e.g. Dev Server. Specify the permissions for that token. Within this workflow I've been walking through here, that is only read access so it can pull within the deployment job. It does not need to be able to write back to the GitLab project, since code changes will always start at local and push through, never the other way around.</p>
<p>Now when you clone the project or add remote for the new server, add it using a variation on the https format rather than the SSH format:</p>
<pre><code>https://oauth2:[token]@[GitLab project address]
</code></pre>
<h2 id="next-drupal-configuration" tabindex="-1">Next: Drupal Configuration <a class="header-anchor" href="#next-drupal-configuration">#</a></h2>
<p>This deploys code changes to the servers. You quite possibly need more actions to take place, like database updates, depending on what platform you're using. In my context of developing this for Drupal, there are several more steps needed. Those will be covered in the next post in this series.</p>
